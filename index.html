<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>
</head>
<body style="margin: 0">
    <script src="http://threejs.org/build/three.js"></script>
    <script src="http://threejs.org/examples/js/shaders/CopyShader.js"></script>
    <script src="http://threejs.org/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="http://threejs.org/examples/js/postprocessing/RenderPass.js"></script>
    <script src="http://threejs.org/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="http://threejs.org/examples/js/controls/OrbitControls.js"></script>
    <script src="http://threejs.org/examples/js/libs/stats.min.js"></script>
    <script src="http://threejs.org/examples/js/libs/dat.gui.min.js"></script>
    <script>
        var EdgeDetectionShader = {

            uniforms: {
                "tDiffuse":       { value: null },
                "enabled":       { value: true },
                "invSize":        {value: new THREE.Vector2(1/window.innerWidth, 1/window.innerHeight)}
            },

            vertexShader: [
                'varying vec2 vUv;',
                'void main() { ',
                    'vUv = uv;',
                    'vec4 modelWorldPosition = modelMatrix* vec4(position, 1.0);',
                    'gl_Position = projectionMatrix * modelViewMatrix  * vec4(position, 1.0);',
                '}'
            ].join('\n'),
            fragmentShader: [
                'varying vec2 vUv;',
                "uniform sampler2D tDiffuse;",
                "uniform vec2 invSize;",
                "uniform bool enabled;",
                'void main(){',
                    "if ( enabled ) {",
                        "vec3 step = vec3(invSize.x, invSize.y, 0.0);",
                        "vec4 texelLeft   = texture2D( tDiffuse, vUv - step.xz );",
                        "vec4 texelRight  = texture2D( tDiffuse, vUv + step.xz );",
                        "vec4 texelTop    = texture2D( tDiffuse, vUv + step.zy );",
                        "vec4 texelBottom = texture2D( tDiffuse, vUv - step.zy );",
                        'gl_FragColor = vec4(1.0) - max(abs(texelRight - texelLeft), abs(texelTop - texelBottom));',
                    '} else {',
                        "vec4 texelCenter = texture2D( tDiffuse, vUv );",
                        'gl_FragColor = texelCenter;',
                    '}',
                '}'
            ].join('\n')
        };
    </script>
    <script>
        var perturbate = true;
        var HandDrawnShader = {

            uniforms: {
                "enabled"   :       { value: perturbate},
                "tDiffuse"  :       { value: null },
                "invSize"   :       { value: new THREE.Vector2(1/window.innerWidth, 1/window.innerHeight)}
            },

            vertexShader: [
                'varying vec2 vUv;',
                'void main() { ',
                    'vUv = uv;',
                    'vec4 modelWorldPosition = modelMatrix* vec4(position, 1.0);',
                    'gl_Position = projectionMatrix * modelViewMatrix  * vec4(position, 1.0);',
                '}'
            ].join('\n'),
            fragmentShader: [
                'varying vec2 vUv;',
                "uniform sampler2D tDiffuse;",
                "uniform vec2 invSize;",
                "uniform bool enabled;",
                'float rand(vec2 co){',
                    'return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);',
                '}',
                'void main(){',
                    "if ( enabled ) {",
                        "vec3 step = vec3(invSize.x, invSize.y, 0.0);",
                        "vec2 perterbudUv = vUv + (2.0 * rand(vUv.xy) - 1.0 ) * vUv * 0.003;",
                        "vec4 texelLeft   = texture2D( tDiffuse, perterbudUv - step.xz );",
                        "vec4 texelRight  = texture2D( tDiffuse, perterbudUv + step.xz );",
                        "vec4 texelTop    = texture2D( tDiffuse, perterbudUv + step.zy );",
                        "vec4 texelBottom = texture2D( tDiffuse, perterbudUv - step.zy );",
                        'gl_FragColor = vec4(1.0) - max(abs(texelRight - texelLeft), abs(texelTop - texelBottom));',
                    '} else {',
                        "vec4 texelCenter = texture2D( tDiffuse, vUv );",
                        'gl_FragColor = texelCenter;',
                    '}',
                '}'
            ].join('\n')
        };
    </script>
    <script>

        //Adding dat.gui
        var gui = new dat.GUI({
            height : 5 * 32 - 1
        });
        var params = {
            showEdges: true,
            perturbate: perturbate,
        };
        gui.add(params, 'showEdges').onFinishChange(function(){
            // refresh based on the new value of params.showEdges
            edgeshaderpass.uniforms["enabled"].value = params.showEdges;
            handshaderpass.uniforms["enabled"].value = params.showEdges && params.perturbate;

        });

        gui.add(params, 'perturbate').onFinishChange(function(){
            // refresh based on the new value of params.perturbate
            handshaderpass.uniforms["enabled"].value = params.showEdges &&  params.perturbate;

        });


        renderer = new THREE.WebGLRenderer();
        renderer.setPixelRatio( window.devicePixelRatio );
        renderer.setSize( window.innerWidth, window.innerHeight );
        document.body.appendChild( renderer.domElement );
        camera = new THREE.PerspectiveCamera( 70, window.innerWidth / window.innerHeight, 1, 1000 );
        camera.position.z = 600;
        camera.position.y = 300;

        scene = new THREE.Scene();
        //scene.fog = new THREE.Fog( 0x000000, 1, 1000 );

        composer = new THREE.EffectComposer( renderer );


        var renderPassTarget = new THREE.WebGLRenderTarget(window.innerWidth, window.innerHeight);
        var renderpass = new THREE.RenderPass( scene, camera );
        //renderpass.renderToScreen = true;

        var edgeshaderpass = new THREE.ShaderPass( EdgeDetectionShader );
        //edgeshaderpass.renderToScreen = true;



        var handshaderpass = new THREE.ShaderPass( HandDrawnShader );

        //renderpass.renderToScreen = true;
        composer.addPass( renderpass );

        //edgeshaderpass.renderToScreen = true;
        composer.addPass( edgeshaderpass );

        handshaderpass.renderToScreen = true;
        composer.addPass( handshaderpass );


        object = new THREE.Object3D();

        controls = new THREE.OrbitControls( camera, renderer.domElement );



        var geometry = new THREE.SphereGeometry( 10, 40, 40 );
        var material = new THREE.MeshBasicMaterial( { color: 0xffffff, shading: THREE.FlatShading } );


        var mesh1 = new THREE.Mesh( new THREE.SphereGeometry( 100, 40, 40 ), material );
        mesh1.position.set(100, 100, 100);

        var mesh2 = new THREE.Mesh( new THREE.BoxGeometry( 100, 40, 40 ), material );
        mesh2.position.set(-100, 100, 100);

        var mesh3 = new THREE.Mesh( new THREE.SphereGeometry( 100, 40, 40 ), material );
        mesh3.position.set(100, -100, 100);

        var mesh4 = new THREE.Mesh( new THREE.SphereGeometry( 100, 40, 40 ), material );
        mesh4.position.set(100, 100, -100);

        object.add( mesh1 );
        object.add( mesh2 );
        object.add( mesh3 );
        object.add( mesh4 );

        scene.add(object);


        scene.add( new THREE.AmbientLight( 0x222222 ) );

        light1 = new THREE.DirectionalLight( 0xffffff );
        light2 = new THREE.DirectionalLight( 0xffffff );
        light1.position.set( 1, 1, 1 );
        light2.position.set( -1, -1, 1 );
        scene.add( light1 );
        scene.add( light2 );

        //Adding stats
        stats = new Stats();
        stats.domElement.style.position = 'absolute';
        stats.domElement.style.top = '5px';
        stats.domElement.style.left = '5px';
        document.body.appendChild( stats.domElement );






        animate();

        function animate() {

            composer.render();

            //object.rotation.x += 0.005;
            object.rotation.y += 0.01;

            stats.update();

            requestAnimationFrame( animate );


        }

    </script>
</body>
</html>